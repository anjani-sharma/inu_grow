{% extends "base.html" %}
{% block title %}Job Matching Results{% endblock %}

{% block content %}
<div class="row justify-content-center py-4">
    <div class="col-lg-10">
        <!-- Header Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4 text-center">
                <h2 class="fw-bold mb-2">CV Analysis Results</h2>
                <p class="text-secondary mb-0">ATS Compatibility | Skills Match | Recommendations</p>
            </div>
        </div>
        
        <!-- Main Score Card -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4 text-center">
                        <h3 class="h5 fw-bold mb-3">ATS Compatibility</h3>
                        <div class="circular-progress mb-3">
                            <svg width="120" height="120">
                                <circle class="circle-bg" cx="60" cy="60" r="50"></circle>
                                <circle class="circle" cx="60" cy="60" r="50" stroke-dasharray="314" stroke-dashoffset="0" id="ats-circle"></circle>
                            </svg>
                            <div class="percentage" id="ats-percentage">{{ analysis_results.ats_score }}%</div>
                        </div>
                        <span class="badge {% if analysis_results.ats_score >= 80 %}bg-success{% elif analysis_results.ats_score >= 60 %}bg-warning{% else %}bg-danger{% endif %} py-2 px-3 mb-3">
                            {% if analysis_results.ats_score >= 80 %}Excellent{% elif analysis_results.ats_score >= 60 %}Good{% else %}Needs Improvement{% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="h5 fw-bold mb-3 text-center">Skills Match</h3>
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex justify-content-between mb-1 small">
                                    <span>Technical Skills</span>
                                    <span class="fw-bold">{{ tech_match_percentage|round(1) }}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ tech_match_percentage }}%" aria-valuenow="{{ tech_match_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex justify-content-between mb-1 small">
                                    <span>Soft Skills</span>
                                    <span class="fw-bold">{{ soft_match_percentage|round(1) }}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ soft_match_percentage }}%" aria-valuenow="{{ soft_match_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1 me-3">
                                <div class="d-flex justify-content-between mb-1 small">
                                    <span>Overall Match</span>
                                    <span class="fw-bold">{{ weighted_match_percentage|round(1) }}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ weighted_match_percentage }}%" aria-valuenow="{{ weighted_match_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <h3 class="h5 fw-bold mb-3">Quick Stats</h3>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Match Type</span>
                                <span class="badge bg-primary rounded-pill">{{ "Excellent" if weighted_match_percentage > 80 else "Good" if weighted_match_percentage > 65 else "Fair" if weighted_match_percentage > 50 else "Poor" }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>Keywords Match</span>
                                <span class="badge bg-primary rounded-pill">{{ analysis_results.keyword_analysis.present_keywords|length }}/{{ (analysis_results.keyword_analysis.present_keywords|length) + (analysis_results.keyword_analysis.missing_keywords|length) }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>ATS Issues</span>
                                <span class="badge bg-{{ 'success' if analysis_results.section_analysis.ats_issues|length == 0 else 'warning' if analysis_results.section_analysis.ats_issues|length < 3 else 'danger' }} rounded-pill">{{ analysis_results.section_analysis.ats_issues|length }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>CV Length</span>
                                <span class="badge bg-warning rounded-pill">~1000 words</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <ul class="nav nav-pills mb-4" id="resultsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="summary-tab" data-bs-toggle="pill" data-bs-target="#summary" type="button" role="tab">Summary</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="detailed-tab" data-bs-toggle="pill" data-bs-target="#detailed" type="button" role="tab">Detailed Analysis</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="optimized-cv-tab" data-bs-toggle="pill" data-bs-target="#optimized-cv" type="button" role="tab">Optimized CV</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cover-letter-tab" data-bs-toggle="pill" data-bs-target="#cover-letter" type="button" role="tab">Cover Letter</button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="resultsTabContent">
            <!-- Summary Tab -->
            <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                <div class="row g-4">
                    <!-- Strengths Card -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-transparent py-3">
                                <h3 class="h5 fw-bold mb-0">
                                    <i class="fas fa-medal text-success me-2"></i>Strengths
                                </h3>
                            </div>
                            <div class="card-body p-4">
                                <ul class="list-group list-group-flush">
                                    {% if analysis_results.strengths %}
                                        {% for strength in analysis_results.strengths %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-check-circle text-success me-2"></i>{{ strength }}
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        {% if analysis_results.ats_analysis.industry_fit and analysis_results.ats_analysis.industry_fit.strengths %}
                                            {% for strength in analysis_results.ats_analysis.industry_fit.strengths %}
                                                <li class="list-group-item px-0 py-2 border-0">
                                                    <i class="fas fa-check-circle text-success me-2"></i>{{ strength }}
                                                </li>
                                            {% endfor %}
                                        {% endif %}
                                        {% if analysis_results.competitive_analysis.skill_depth and analysis_results.competitive_analysis.skill_depth.strengths %}
                                            {% for strength in analysis_results.competitive_analysis.skill_depth.strengths %}
                                                <li class="list-group-item px-0 py-2 border-0">
                                                    <i class="fas fa-check-circle text-success me-2"></i>{{ strength }}
                                                </li>
                                            {% endfor %}
                                        {% endif %}
                                        {% if not (analysis_results.ats_analysis.industry_fit and analysis_results.ats_analysis.industry_fit.strengths) and not (analysis_results.competitive_analysis.skill_depth and analysis_results.competitive_analysis.skill_depth.strengths) %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-check-circle text-success me-2"></i>Technical skills match job requirements
                                            </li>
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-check-circle text-success me-2"></i>Clear structure and formatting
                                            </li>
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-check-circle text-success me-2"></i>Good ATS compatibility score
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Areas for Improvement Card -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-transparent py-3">
                                <h3 class="h5 fw-bold mb-0">
                                    <i class="fas fa-tools text-warning me-2"></i>Areas for Improvement
                                </h3>
                            </div>
                            <div class="card-body p-4">
                                <ul class="list-group list-group-flush">
                                    {% if analysis_results.areas_for_improvement %}
                                        {% for area in analysis_results.areas_for_improvement %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-exclamation-circle text-warning me-2"></i>{{ area }}
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        {% if analysis_results.ats_analysis.industry_fit and analysis_results.ats_analysis.industry_fit.weaknesses %}
                                            {% for weakness in analysis_results.ats_analysis.industry_fit.weaknesses %}
                                                <li class="list-group-item px-0 py-2 border-0">
                                                    <i class="fas fa-exclamation-circle text-warning me-2"></i>{{ weakness }}
                                                </li>
                                            {% endfor %}
                                        {% endif %}
                                        {% if analysis_results.competitive_analysis.skill_depth and analysis_results.competitive_analysis.skill_depth.gaps %}
                                            {% for gap in analysis_results.competitive_analysis.skill_depth.gaps %}
                                                <li class="list-group-item px-0 py-2 border-0">
                                                    <i class="fas fa-exclamation-circle text-warning me-2"></i>{{ gap }}
                                                </li>
                                            {% endfor %}
                                        {% endif %}
                                        {% if not (analysis_results.ats_analysis.industry_fit and analysis_results.ats_analysis.industry_fit.weaknesses) and not (analysis_results.competitive_analysis.skill_depth and analysis_results.competitive_analysis.skill_depth.gaps) %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-exclamation-circle text-warning me-2"></i>Add more job-specific keywords
                                            </li>
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-exclamation-circle text-warning me-2"></i>Include more quantifiable achievements
                                            </li>
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-exclamation-circle text-warning me-2"></i>Optimize CV length for better readability
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations Card -->
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent py-3">
                                <h3 class="h5 fw-bold mb-0">
                                    <i class="fas fa-lightbulb text-primary me-2"></i>Recommendations
                                </h3>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-4">
                                    {% if analysis_results.recommendations %}
                                        {% for recommendation in analysis_results.recommendations %}
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="flex-shrink-0">
                                                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-arrow-right text-primary"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <p class="mb-0">{{ recommendation }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        {% if analysis_results.ats_analysis.structure_analysis and analysis_results.ats_analysis.structure_analysis.recommendations %}
                                            {% for rec in analysis_results.ats_analysis.structure_analysis.recommendations %}
                                                <div class="col-md-6">
                                                    <div class="d-flex">
                                                        <div class="flex-shrink-0">
                                                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                <i class="fas fa-arrow-right text-primary"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <p class="mb-0">{{ rec }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        {% if analysis_results.competitive_analysis.overall_recommendations %}
                                            {% for rec in analysis_results.competitive_analysis.overall_recommendations %}
                                                <div class="col-md-6">
                                                    <div class="d-flex">
                                                        <div class="flex-shrink-0">
                                                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                <i class="fas fa-arrow-right text-primary"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <p class="mb-0">{{ rec }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        {% if not (analysis_results.ats_analysis.structure_analysis and analysis_results.ats_analysis.structure_analysis.recommendations) and not analysis_results.competitive_analysis.overall_recommendations %}
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="flex-shrink-0">
                                                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-arrow-right text-primary"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <p class="mb-0">Add the missing keywords identified in the analysis to improve match rate</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="flex-shrink-0">
                                                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-arrow-right text-primary"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <p class="mb-0">Format your CV with clear section headers to improve ATS compatibility</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="flex-shrink-0">
                                                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-arrow-right text-primary"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1 ms-3">
                                                        <p class="mb-0">Quantify achievements with specific metrics and results</p>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Analysis Tab -->
            <div class="tab-pane fade" id="detailed" role="tabpanel" aria-labelledby="detailed-tab">
                <div class="row g-4">
                    <!-- Keyword Analysis Card -->
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent py-3">
                                <h3 class="h5 fw-bold mb-0">
                                    <i class="fas fa-key text-primary me-2"></i>Keyword Analysis
                                </h3>
                            </div>
                            <div class="card-body p-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="fw-bold mb-3">Skills Comparison</h5>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Skill</th>
                                                        <th class="text-center">Resume</th>
                                                        <th class="text-center">Job Description</th>
                                                        <th class="text-center">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for skill in job_technical_skills %}
                                                    <tr>
                                                        <td>{{ skill }}</td>
                                                        <td class="text-center">
                                                            {% if cv_skill_freq is defined and cv_skill_freq %}
                                                                {{ cv_skill_freq.get(skill, 0) }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if job_skill_freq is defined and job_skill_freq %}
                                                                {{ job_skill_freq.get(skill, 0) }}
                                                            {% else %}
                                                                1
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if cv_skill_freq is defined and cv_skill_freq and cv_skill_freq.get(skill, 0) > 0 %}
                                                                <i class="fas fa-check-circle text-success"></i>
                                                            {% else %}
                                                                <i class="fas fa-times-circle text-danger"></i>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                    
                                                    {% for skill in job_soft_skills %}
                                                    <tr>
                                                        <td>{{ skill }} <small class="text-secondary">(Soft Skill)</small></td>
                                                        <td class="text-center">
                                                            {% if cv_skill_freq is defined and cv_skill_freq %}
                                                                {{ cv_skill_freq.get(skill, 0) }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if job_skill_freq is defined and job_skill_freq %}
                                                                {{ job_skill_freq.get(skill, 0) }}
                                                            {% else %}
                                                                1
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% if cv_skill_freq is defined and cv_skill_freq and cv_skill_freq.get(skill, 0) > 0 %}
                                                                <i class="fas fa-check-circle text-success"></i>
                                                            {% else %}
                                                                <i class="fas fa-times-circle text-danger"></i>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="fw-bold mb-3">Present Keywords</h5>
                                        <div class="d-flex flex-wrap mb-4">
                                            {% if analysis_results.keyword_analysis.present_keywords and analysis_results.keyword_analysis.present_keywords|length > 0 %}
                                                {% for keyword in analysis_results.keyword_analysis.present_keywords %}
                                                    <span class="badge badge-present me-2 mb-2">{{ keyword }}</span>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-secondary">No present keywords detected</p>
                                            {% endif %}
                                        </div>
                                        
                                        <h5 class="fw-bold mb-3">Missing Keywords</h5>
                                        <div class="d-flex flex-wrap">
                                            {% if analysis_results.keyword_analysis.missing_keywords and analysis_results.keyword_analysis.missing_keywords|length > 0 %}
                                                {% for keyword in analysis_results.keyword_analysis.missing_keywords %}
                                                    <span class="badge badge-missing me-2 mb-2">{{ keyword }}</span>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-secondary">No missing keywords detected</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Issue Cards -->
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-transparent py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h3 class="h5 fw-bold mb-0">
                                        <i class="fas fa-search text-primary me-2"></i>ATS Issues
                                    </h3>
                                    <span class="badge bg-{{ 'success' if analysis_results.section_analysis.ats_issues|length == 0 else 'warning' }}">
                                        {{ analysis_results.section_analysis.ats_issues|length }} issues
                                    </span>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                {% if analysis_results.section_analysis.ats_issues and analysis_results.section_analysis.ats_issues|length > 0 %}
                                    <ul class="list-group list-group-flush">
                                        {% for issue in analysis_results.section_analysis.ats_issues %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ issue }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="text-center py-3">
                                        <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                                        <p class="mb-0">No ATS issues detected. Your CV is well-structured for automated systems.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-transparent py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h3 class="h5 fw-bold mb-0">
                                        <i class="fas fa-user-tie text-primary me-2"></i>Recruiter Tips
                                    </h3>
                                    <span class="badge bg-warning">
                                        Tips
                                    </span>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <ul class="list-group list-group-flush">
                                    {% if analysis_results.section_analysis.present_sections|length < 3 %}
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>Add clear section headers (e.g., Work Experience, Education).
                                        </li>
                                    {% endif %}
                                    
                                    {% if analysis_results.achievement_analysis.experience_warning %}
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ analysis_results.achievement_analysis.experience_warning }}
                                        </li>
                                    {% endif %}
                                    
                                    {% if analysis_results.achievement_analysis.tone_warning %}
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ analysis_results.achievement_analysis.tone_warning }}
                                        </li>
                                    {% endif %}
                                    
                                    {% if analysis_results.achievement_analysis.achievement_recommendations %}
                                        {% for recommendation in analysis_results.achievement_analysis.achievement_recommendations %}
                                            <li class="list-group-item px-0 py-2 border-0">
                                                <i class="fas fa-lightbulb text-primary me-2"></i>{{ recommendation }}
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if not analysis_results.achievement_analysis.experience_warning and not analysis_results.achievement_analysis.tone_warning and not analysis_results.achievement_analysis.achievement_recommendations %}
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-lightbulb text-primary me-2"></i>Keep your CV concise and focused on relevant experience
                                        </li>
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-lightbulb text-primary me-2"></i>Use action verbs to begin achievement statements
                                        </li>
                                        <li class="list-group-item px-0 py-2 border-0">
                                            <i class="fas fa-lightbulb text-primary me-2"></i>Tailor your CV for each job application
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Optimized CV Tab -->
            <div class="tab-pane fade" id="optimized-cv" role="tabpanel" aria-labelledby="optimized-cv-tab">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 fw-bold mb-0">
                                <i class="fas fa-file-alt text-primary me-2"></i>Optimized CV
                            </h3>
                            
                            <div class="d-flex align-items-center">
                                {% if cv_id %}
                                <!-- Template selector dropdown -->
                                <div class="dropdown me-2">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Choose Template
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="templateDropdown">
                                        {% for id, template in templates.items() %}
                                            <li><a class="dropdown-item template-select" href="#" data-template="{{ id }}">{{ template.name }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <!-- Download buttons -->
                                <a href="{{ url_for('download_optimized_cv', content=optimized_cv) }}" class="btn btn-primary btn-sm default-download">
                                    <i class="fas fa-download me-2"></i>Download
                                </a>
                                <a href="#" id="templateDownloadBtn" class="btn btn-success btn-sm d-none template-download">
                                    <i class="fas fa-download me-2"></i>Download Formatted
                                </a>
                                {% else %}
                                <a href="{{ url_for('download_optimized_cv', content=optimized_cv) }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download me-2"></i>Download
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div id="cvPreviewContainer">
                            <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ optimized_cv }}</pre>
                        </div>
                    </div>
                    
                    {% if cv_id %}
                    <!-- Template preview functionality -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Track currently selected template
                            let currentTemplate = null;
                            let downloadUrl = null;
                            
                            // Get elements
                            const templateSelects = document.querySelectorAll('.template-select');
                            const defaultDownloadBtn = document.querySelector('.default-download');
                            const templateDownloadBtn = document.querySelector('.template-download');
                            const cvPreviewContainer = document.getElementById('cvPreviewContainer');
                            
                            // Template selection
                            templateSelects.forEach(select => {
                                select.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    
                                    // Get template ID
                                    currentTemplate = this.getAttribute('data-template');
                                    
                                    // Update dropdown button text
                                    document.getElementById('templateDropdown').textContent = this.textContent;
                                    
                                    // Get formatted CV preview
                                    getFormattedCVPreview(currentTemplate);
                                });
                            });
                            
                            // Get formatted CV preview
                            function getFormattedCVPreview(templateId) {
                                // Show loading indicator
                                cvPreviewContainer.innerHTML = '<div class="text-center my-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Generating formatted CV preview...</p></div>';
                                
                                // Call API
                                fetch('{{ url_for("get_formatted_cv") }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        template: templateId,
                                        cv_id: {{ cv_id|default(0) }},
                                        optimized_content: `{{ optimized_cv|safe }}`
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.error) {
                                        cvPreviewContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                                        return;
                                    }
                                    
                                    // Update preview
                                    cvPreviewContainer.innerHTML = `<div class="bg-light p-3 rounded resume-preview" style="white-space: pre-wrap;">${formatPreviewAsHtml(data.formattedResume)}</div>`;
                                    
                                    // Update download button
                                    downloadUrl = data.downloadUrl;
                                    templateDownloadBtn.href = downloadUrl;
                                    templateDownloadBtn.classList.remove('d-none');
                                    defaultDownloadBtn.classList.add('d-none');
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    cvPreviewContainer.innerHTML = '<div class="alert alert-danger">Failed to generate formatted CV preview. Please try again.</div>';
                                });
                            }
                            
                            // Format preview as HTML
                            function formatPreviewAsHtml(text) {
                                // Split the text into lines
                                const lines = text.split('\n');
                                let html = '';
                                let inSkillsSection = false;
                                let inList = false;
                                
                                // Process the first line as the name (assuming it's the name)
                                if (lines.length > 0) {
                                    html += `<h1 style="font-size: 24px; text-align: center; margin-top: 0; margin-bottom: 5px; color: #2c3e50;">${lines[0]}</h1>`;
                                }
                                
                                // Process the second line as contact info
                                if (lines.length > 1) {
                                    html += `<div style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #555;">${lines[1]}</div>`;
                                }
                                
                                // Process the rest of the lines
                                for (let i = 2; i < lines.length; i++) {
                                    const line = lines[i].trim();
                                    
                                    // Skip empty lines
                                    if (!line) {
                                        if (inList) {
                                            html += '</ul>';
                                            inList = false;
                                        }
                                        continue;
                                    }
                                    
                                    // Check if it's a section header
                                    if (line.toUpperCase() === line && line.length > 3) {
                                        if (inList) {
                                            html += '</ul>';
                                            inList = false;
                                        }
                                        
                                        // Section header
                                        html += `<h2 style="font-size: 16px; text-transform: uppercase; margin-top: 15px; margin-bottom: 10px; color: #2980b9; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px;">${line}</h2>`;
                                        
                                        // Check if we're entering the skills section
                                        inSkillsSection = line.includes('SKILLS');
                                        continue;
                                    }
                                    
                                    // If we're in the skills section, format as bullet points
                                    if (inSkillsSection) {
                                        // Format skills with bullets
                                        const skills = line.split('•').map(s => s.trim()).filter(s => s);
                                        
                                        if (skills.length > 0) {
                                            if (!inList) {
                                                html += '<ul style="display: flex; flex-wrap: wrap; gap: 8px; list-style-type: none; margin-left: 0; padding-left: 0;">';
                                                inList = true;
                                            }
                                            
                                            skills.forEach(skill => {
                                                html += `<li style="background-color: #f8f9fa; border-radius: 3px; padding: 2px 8px; font-size: 14px; display: inline-block; margin-bottom: 5px;">${skill}</li>`;
                                            });
                                        }
                                    } 
                                    // If line starts with a bullet point or asterisk
                                    else if (line.startsWith('•') || line.startsWith('*') || line.startsWith('-')) {
                                        if (!inList) {
                                            html += '<ul style="margin-left: 20px; margin-bottom: 10px; padding-left: 0;">';
                                            inList = true;
                                        }
                                        
                                        // Remove the bullet point character and trim
                                        const content = line.substring(1).trim();
                                        html += `<li style="margin-bottom: 5px; list-style-type: disc;">${content}</li>`;
                                    } 
                                    // Regular paragraph
                                    else {
                                        if (inList) {
                                            html += '</ul>';
                                            inList = false;
                                        }
                                        
                                        html += `<p style="margin-bottom: 10px;">${line}</p>`;
                                    }
                                }
                                
                                // Close any open list
                                if (inList) {
                                    html += '</ul>';
                                }
                                
                                return html;
                            }
                        });
                    </script>
                    {% endif %}
                </div>
            </div>
            
            <!-- Cover Letter Tab -->
            <div class="tab-pane fade" id="cover-letter" role="tabpanel" aria-labelledby="cover-letter-tab">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 fw-bold mb-0">
                                <i class="fas fa-envelope text-primary me-2"></i>Cover Letter
                            </h3>
                            <a href="{{ url_for('download_cover_letter', content=cover_letter) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-2"></i>Download
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ cover_letter }}</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('analyze') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to Analyze
            </a>
            <a href="{{ url_for('job_search') }}" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Find Jobs
            </a>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up ATS score circle animation
        const atsScore = {{ analysis_results.ats_score }};
        const circle = document.getElementById('ats-circle');
        const circumference = 314; // 2 * π * r (r = 50)
        const offset = circumference - (atsScore / 100) * circumference;
        
        // Animate the circle filling
        setTimeout(() => {
            circle.style.strokeDashoffset = offset;
            circle.style.transition = 'stroke-dashoffset 1s ease-in-out';
        }, 300);
        
        // Initialize Bootstrap tabs
        const triggerTabList = [].slice.call(document.querySelectorAll('#resultsTab button'));
        triggerTabList.forEach(function(triggerEl) {
            const tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener('click', function(event) {
                event.preventDefault();
                tabTrigger.show();
            });
        });
    });
</script>
{% endblock %}
{% endblock %}