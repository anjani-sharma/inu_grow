{% extends "base.html" %}
{% block title %}Job Matching Results{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center">
                <h2 class="card-title">Job Matching Results</h2>
                <p class="text-muted">ATS Compatibility | Skills Match | Recommendations</p>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">ATS Compatibility Score</h3>
                <div class="circular-progress">
                    <svg width="100" height="100">
                        <circle class="circle-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="circle" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="0" id="ats-circle"></circle>
                    </svg>
                    <div class="percentage" id="ats-percentage">{{ analysis_results.ats_score }}%</div>
                </div>
                <p>Weighted Match (Technical 70%, Soft 30%): {{ weighted_match_percentage|round(2) }}%</p>
                <p>Technical Skill Match: {{ tech_match_percentage|round(2) }}%</p>
                <p>Soft Skill Match: {{ soft_match_percentage|round(2) }}%</p>
                <div class="text-center">
                    <button class="btn btn-primary" onclick="toggleDetailedAnalysis()">Detailed Analysis</button>
                </div>
            </div>
        </div>

        <div id="detailed-analysis" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h3 class="card-title">Strengths</h3>
                            <ul class="list-unstyled">
                                {% for strength in analysis_results.strengths %}
                                <li class="mb-2">• {{ strength }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h3 class="card-title">Areas for Improvement</h3>
                            <ul class="list-unstyled">
                                {% for area in analysis_results.areas_for_improvement %}
                                <li class="mb-2">• {{ area }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title">Recommendations</h3>
                    <ul class="list-unstyled">
                        {% for recommendation in analysis_results.recommendations %}
                        <li class="mb-2">• {{ recommendation }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="card-title">Keyword Analysis</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Skills Comparison</h5>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Skill</th>
                                        <th>Resume</th>
                                        <th>Job Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for skill in job_technical_skills %}
                                    <tr>
                                        <td>{{ skill }}</td>
                                        <td>{{ cv_skill_freq[skill] }}</td>
                                        <td>{{ job_skill_freq[skill] }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% for skill in job_soft_skills %}
                                    <tr>
                                        <td>{{ skill }}</td>
                                        <td>{{ cv_skill_freq[skill] }}</td>
                                        <td>{{ job_skill_freq[skill] }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Present Keywords</h5>
                            <div class="d-flex flex-wrap">
                                {% for keyword in analysis_results.keyword_analysis.present_keywords %}
                                <span class="badge badge-present me-2 mb-2">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                            <h5>Missing Common Keywords</h5>
                            <div class="d-flex flex-wrap">
                                {% for keyword in analysis_results.keyword_analysis.missing_keywords %}
                                <span class="badge badge-missing me-2 mb-2">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Optimized CV</h3>
                <pre>{{ optimized_cv }}</pre>
                <a href="{{ url_for('download_optimized_cv', content=optimized_cv) }}" class="btn btn-primary">Download Optimized CV</a>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Cover Letter</h3>
                <pre>{{ cover_letter }}</pre>
                <a href="{{ url_for('download_cover_letter', content=cover_letter) }}" class="btn btn-primary">Download Cover Letter</a>
            </div>
        </div>

        <div class="text-center mb-4">
            <a href="{{ url_for('analyze') }}" class="btn btn-primary">Back to Job Description</a>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Searchability <span class="badge bg-warning">{{ analysis_results.section_analysis.ats_issues|length }} issues to fix</span></h3>
                <ul class="list-unstyled">
                    {% for issue in analysis_results.section_analysis.ats_issues %}
                    <li class="mb-2">• {{ issue }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Hard Skills <span class="badge bg-warning">{{ 1 if tech_match_percentage < 70 else 0 }} issues to fix</span></h3>
                <ul class="list-unstyled">
                    {% if tech_match_percentage < 70 %}
                    <li class="mb-2">• Technical skill match is low ({{ tech_match_percentage }}%). Consider adding: {{ missing_technical_keywords|join(', ') }}</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Soft Skills <span class="badge bg-warning">{{ 1 if soft_match_percentage < 70 else 0 }} issues to fix</span></h3>
                <ul class="list-unstyled">
                    {% if soft_match_percentage < 70 %}
                    <li class="mb-2">• Soft skill match is low ({{ soft_match_percentage }}%). Consider adding: {{ missing_soft_keywords|join(', ') }}</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Recruiter Tips <span class="badge bg-warning">{{ (cv_text|wordcount > 600)|int + (analysis_results.section_analysis.present_sections|length < 3)|int + (analysis_results.achievement_analysis.experience_warning is not none)|int + (analysis_results.achievement_analysis.tone_warning is not none)|int }} issues to fix</span></h3>
                <ul class="list-unstyled">
                    {% if cv_text|wordcount > 600 %}
                    <li class="mb-2">• CV too long ({{ cv_text|wordcount }} words). Aim for 1-2 pages.</li>
                    {% endif %}
                    {% if analysis_results.section_analysis.present_sections|length < 3 %}
                    <li class="mb-2">• Add clear section headers (e.g., Work Experience, Education).</li>
                    {% endif %}
                    {% if analysis_results.achievement_analysis.experience_warning %}
                    <li class="mb-2">• {{ analysis_results.achievement_analysis.experience_warning }}</li>
                    {% endif %}
                    {% if analysis_results.achievement_analysis.tone_warning %}
                    <li class="mb-2">• {{ analysis_results.achievement_analysis.tone_warning }}</li>
                    {% endif %}
                    {% for recommendation in analysis_results.achievement_analysis.achievement_recommendations %}
                    <li class="mb-2">• {{ recommendation }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h3 class="card-title">Formatting <span class="badge bg-warning">{{ ('table format' in cv_text.lower() or 'image embedded' in cv_text.lower())|int }} issues to fix</span></h3>
                <ul class="list-unstyled">
                    {% if 'table format' in cv_text.lower() or 'image embedded' in cv_text.lower() %}
                    <li class="mb-2">• Avoid tables or images for ATS compatibility.</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const atsScore = {{ analysis_results.ats_score }};
        const circle = document.getElementById('ats-circle');
        const circumference = 283;
        const offset = circumference - (atsScore / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    });

    function toggleDetailedAnalysis() {
        const detailedAnalysis = document.getElementById('detailed-analysis');
        detailedAnalysis.style.display = detailedAnalysis.style.display === 'none' ? 'block' : 'none';
    }
</script>
{% endblock %}